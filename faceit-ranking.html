<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Единый список игроков и их FACEIT рейтинг" />
  <title>FACEIT рейтинг — LABEL 52</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .table-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; backdrop-filter: blur(20px); }
    .table-card table { width: 100%; border-collapse: collapse; min-width: 720px; }
    .table-card thead th { text-align: left; font-weight: 600; font-size: 0.9rem; letter-spacing: .02em; padding: 12px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
    .table-card tbody td { padding: 12px 16px; border-bottom: 1px dotted var(--border-color); vertical-align: middle; color: var(--text-secondary); }
    .table-card tbody tr:last-child td { border-bottom: none; }
    .player { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 28px; height: 28px; border-radius: 16px; object-fit: cover; border: 1px solid var(--border-color); }
    .loading { padding: 14px; text-align: center; }
  </style>
</head>
<body>
  <!-- Навигация -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <h2><a href="index.html" style="color: inherit; text-decoration: none;">LABEL 52</a></h2>
      </div>
      <ul class="nav-menu">
        <li><a href="index.html#home" class="nav-link">Главная</a></li>
        <li><a href="faceit-ranking.html" class="nav-link">FACEIT Рейтинг</a></li>
        <li><a href="spotify-stats.html" class="nav-link">Spotify Статистика</a></li>
      </ul>
      <div class="hamburger">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
    </div>
  </nav>

  <!-- Контент -->
  <section class="releases" style="padding-top: 8rem;">
    <div class="container">
      <div class="section-header" style="display:flex; align-items:flex-end; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
          <h2 class="section-title">FACEIT рейтинг (единый список)</h2>
          <p class="section-subtitle">Список из БД, данные по нику из FACEIT API</p>
        </div>
        <div style="display:flex; gap:.75rem; align-items:center;">
          <div>
            <label for="group-filter" style="display:block; font-size:.85rem; color: var(--text-secondary); margin-bottom:.25rem;">Фильтр по группе</label>
            <select id="group-filter" style="padding:.55rem .8rem; background: rgba(255,255,255,0.05); border:1px solid var(--border-color); color: var(--text-primary); border-radius:8px;">
              <option value="ALL">Все</option>
              <option value="Черные">Черные</option>
              <option value="Музыка">Музыка</option>
              <option value="Без группы">Без группы</option>
            </select>
          </div>
          <button id="open-add-player" class="btn btn-secondary" title="Добавить игрока" aria-label="Добавить игрока">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>

      <div class="table-card" role="region" aria-label="FACEIT рейтинг игроков">
        <div style="overflow-x:auto;">
          <table role="table" aria-label="Таблица FACEIT">
            <thead>
              <tr>
                <th scope="col">Имя</th>
                <th scope="col">LVL</th>
                <th scope="col" id="sort-elo" style="cursor:pointer;">ELO</th>
                <th scope="col" id="sort-matches" style="cursor:pointer;">Матчей</th>
                <th scope="col">Действия</th>
              </tr>
            </thead>
            <tbody id="faceit-table-body">
              <tr><td class="loading" colspan="6" aria-live="polite">Загрузка…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="section-subtitle" style="margin-top: 1rem;">Редактирование: таблица <code>public.players</code> (Supabase) — поля <code>nickname</code>, <code>display_name</code>, <code>sort_order</code>.</p>
    </div>
  </section>

  <!-- Футер -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <h3><a href="index.html" style="color: inherit; text-decoration: none;">LABEL 52</a></h3>
          <p>Музыка будущего</p>
        </div>
        <div class="footer-links">
          <div class="footer-section">
            <h4>Лейбл</h4>
            <ul>
              <li><a href="index.html#artists">Артисты</a></li>
              <li><a href="index.html#releases">Релизы</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Поддержка</h4>
            <ul>
              <li><a href="#">FAQ</a></li>
              <li><a href="#">Прайваси</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 LABEL 52. Все права защищены.</p>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // === ТВОИ КЛЮЧИ (уже подставлены) ===
    const SUPABASE_URL = "https://wpsjgygdbkvdjkikvzws.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwc2pneWdkYmt2ZGpraWt2endzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDMzMDQsImV4cCI6MjA3MTkxOTMwNH0.m1DFironTn3qT9aNNnCafYs81pTPQlsCVzw79Ss1QOg";
    const FACEIT_API_KEY = "73782652-2cd5-405b-9c98-d28b2620bd0c";
    // =====================================

    const FACEIT_API = "https://open.faceit.com/data/v4";
    const TABLE_BODY_ID = "faceit-table-body";
    const GROUPS = ["Без группы", "Черные", "Музыка"];
    let CURRENT_ITEMS = [];
    let SORT_BY = null; // 'elo' | 'matches'
    let SORT_DIR = 'desc';
    let FILTER_GROUP = 'ALL';

    // маленький лимитер параллельных запросов
    async function mapLimit(arr, limit, iter) {
      const ret = [];
      const executing = [];
      for (const item of arr) {
        const p = Promise.resolve().then(() => iter(item));
        ret.push(p);
        if (limit <= arr.length) {
          const e = p.then(() => executing.splice(executing.indexOf(e), 1));
          executing.push(e);
          if (executing.length >= limit) await Promise.race(executing);
        }
      }
      return Promise.all(ret);
    }

    // 1) Читаем ЕДИНЫЙ список игроков из БД
    async function fetchPlayersList() {
      const url = `${SUPABASE_URL}/rest/v1/players?select=nickname,display_name,sort_order,group_name&order=sort_order.asc`;
      const res = await fetch(url, { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }});
      if (!res.ok) throw new Error("Не удалось получить список игроков из БД");
      return res.json();
    }

    // 2) По нику — данные из FACEIT
    async function fetchFaceitByNickname(nickname) {
      const res = await fetch(`${FACEIT_API}/players?nickname=${encodeURIComponent(nickname)}`, {
        headers: { Authorization: `Bearer ${FACEIT_API_KEY}` }
      });
      if (!res.ok) return { error: true, nickname };
      const info = await res.json();

      // пробуем достать инфо по CS2; при необходимости замени на другую игру
      const cs2 = info.games?.cs2 ?? {};
      const level = cs2.skill_level ?? null;
      const elo = cs2.faceit_elo ?? null;
      const region = cs2.region ?? info.country ?? null;

      return {
        nickname: info.nickname || nickname,
        player_id: info.player_id,
        steam_nickname: info.steam_nickname ?? null,
        faceit_url: `https://www.faceit.com/ru/players/${encodeURIComponent(info.nickname || nickname)}`,
        avatar: info.avatar ?? null,
        level, elo, region
      };
    }

    async function fetchMatchesCount(playerId) {
      try {
        // Статистика по CS2; при необходимости поменять game_id
        const res = await fetch(`${FACEIT_API}/players/${encodeURIComponent(playerId)}/stats/cs2`, {
          headers: { Authorization: `Bearer ${FACEIT_API_KEY}` }
        });
        if (!res.ok) return null;
        const data = await res.json();
        // Пытаемся извлечь количество матчей из разных возможных полей
        const life = data.lifetime || data.LIFETIME || {};
        return Number(life.Matches || life.matches || life.Total_Matches || life["Total Matches"]) || null;
      } catch (_) {
        return null;
      }
    }

    // 3) Рендер таблицы
    function applyFilterSort(items) {
      let out = Array.from(items);
      if (FILTER_GROUP !== 'ALL') {
        out = out.filter(x => (x.group_name || 'Без группы') === FILTER_GROUP);
      }
      if (SORT_BY === 'elo') {
        out.sort((a,b) => (Number(b.elo||0) - Number(a.elo||0)) * (SORT_DIR==='desc'?1:-1));
      } else if (SORT_BY === 'matches') {
        out.sort((a,b) => (Number(b.matches_count||0) - Number(a.matches_count||0)) * (SORT_DIR==='desc'?1:-1));
      }
      return out;
    }

    function renderRows(items) {
      const tbody = document.getElementById(TABLE_BODY_ID);
      tbody.innerHTML = "";

      if (!items.length) {
        tbody.innerHTML = `<tr><td class="loading" colspan="6">Список пуст</td></tr>`;
        return;
      }

      for (const row of applyFilterSort(items)) {
        const tr = document.createElement("tr");

        const avatarImg = row.avatar ? `<img class="avatar" src="${row.avatar}" alt="Аватар ${row.display_name}">` : "";
        const profileLinkOpen = row.faceit_url ? `<a href="${row.faceit_url}" target="_blank" rel="noopener">` : "";
        const profileLinkClose = row.faceit_url ? `</a>` : "";

        const safeData = encodeURIComponent(JSON.stringify(row));
        tr.innerHTML = `
          <td>
            <div class="player">
              ${avatarImg}
              ${profileLinkOpen}${row.display_name}${profileLinkClose}
            </div>
          </td>
          <td>${row.level ?? "—"}</td>
          <td>${row.elo ?? "—"}</td>
          <td>${row.matches_count ?? "—"}</td>
          <td style="display:flex; gap:.5rem;">
            <button class="btn btn-secondary" data-player='${safeData}'>Подробнее</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Навесим обработчики на кнопки
      tbody.querySelectorAll('button[data-player]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const raw = e.currentTarget.getAttribute('data-player');
          try {
            const player = JSON.parse(decodeURIComponent(raw));
            openDetailsModal(player);
          } catch (_) {}
        });
      });
    }

    // 4) Главная функция
    async function loadFaceitTable() {
      const tbody = document.getElementById(TABLE_BODY_ID);
      tbody.innerHTML = `<tr><td class="loading" colspan="6" aria-live="polite">Загрузка…</td></tr>`;

      try {
        const list = await fetchPlayersList(); // [{nickname, display_name, sort_order}, ...]
        // ограничим до 3 параллельных обращений к FACEIT
        const details = await mapLimit(list, 3, async (p) => {
          const info = await fetchFaceitByNickname(p.nickname);
          return {
            display_name: p.display_name,
            nickname: info.nickname ?? p.nickname,
            level: info.level ?? null,
            elo: info.elo ?? null,
            matches_count: info.player_id ? await fetchMatchesCount(info.player_id) : null,
            steam_nickname: info.steam_nickname ?? null,
            avatar: info.avatar ?? null,
            faceit_url: info.faceit_url ?? null,
            group_name: p.group_name || 'Без группы'
          };
        });

        CURRENT_ITEMS = details;
        renderRows(CURRENT_ITEMS);
      } catch (err) {
        tbody.innerHTML = `<tr><td class="loading" colspan="6">Ошибка: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // Простое модальное окно для подробной статистики
    function openDetailsModal(player) {
      const modal = document.getElementById('faceit-modal');
      const overlay = document.getElementById('faceit-modal-overlay');
      const titleEl = document.getElementById('faceit-modal-title');
      const bodyEl = document.getElementById('faceit-modal-body');

      titleEl.textContent = player.display_name || player.nickname || 'Профиль';
      const profileLink = player.faceit_url ? `<a href="${player.faceit_url}" target="_blank" rel="noopener">Открыть профиль Faceit</a>` : '';
      bodyEl.innerHTML = `
        <div style="display:grid; gap:.5rem;">
          <div><strong>LVL:</strong> ${player.level ?? '—'}</div>
          <div><strong>ELO:</strong> ${player.elo ?? '—'}</div>
          <div><strong>Матчей:</strong> ${player.matches_count ?? '—'}</div>
          <div>${profileLink}</div>
        </div>
      `;

      overlay.style.display = 'block';
      modal.style.display = 'block';
    }

    function closeDetailsModal() {
      const modal = document.getElementById('faceit-modal');
      const overlay = document.getElementById('faceit-modal-overlay');
      overlay.style.display = 'none';
      modal.style.display = 'none';
    }

    document.addEventListener('click', (e) => {
      if (e.target && (e.target.id === 'faceit-modal-close' || e.target.id === 'faceit-modal-overlay')) {
        closeDetailsModal();
      }
    });

    // Сортировка
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'sort-elo') {
        SORT_BY = 'elo';
        SORT_DIR = SORT_DIR === 'desc' ? 'asc' : 'desc';
        renderRows(CURRENT_ITEMS);
      } else if (e.target && e.target.id === 'sort-matches') {
        SORT_BY = 'matches';
        SORT_DIR = SORT_DIR === 'desc' ? 'asc' : 'desc';
        renderRows(CURRENT_ITEMS);
      }
    });

    // Фильтр по группе
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'group-filter') {
        FILTER_GROUP = e.target.value;
        renderRows(CURRENT_ITEMS);
      }
    });

    // Модалка добавления игрока
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'open-add-player') {
        openAddPlayerModal();
      }
    });

    async function insertPlayer({ display_name, nickname, group_name }) {
      if (!display_name || !nickname) throw new Error('Введите имя и ник');
      // Ограничим sort_order значением в секундах, чтобы поместиться в INT32
      const sortOrder = Math.min(2147483647, Math.floor(Date.now() / 1000));
      const body = [{ display_name, nickname, group_name, sort_order: sortOrder }];
      const res = await fetch(`${SUPABASE_URL}/rest/v1/players`, {
        method: 'POST',
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          Prefer: 'return=representation'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>"");
        throw new Error('Не удалось добавить игрока. ' + t);
      }
      return res.json();
    }

    function openAddPlayerModal() {
      const overlay = document.getElementById('faceit-add-overlay');
      const modal = document.getElementById('faceit-add-modal');
      overlay.style.display = 'block';
      modal.style.display = 'block';
    }

    function closeAddPlayerModal() {
      const overlay = document.getElementById('faceit-add-overlay');
      const modal = document.getElementById('faceit-add-modal');
      overlay.style.display = 'none';
      modal.style.display = 'none';
    }

    document.addEventListener('click', async (e) => {
      if (e.target && (e.target.id === 'faceit-add-close' || e.target.id === 'faceit-add-overlay')) {
        closeAddPlayerModal();
      }
      if (e.target && e.target.id === 'faceit-add-save') {
        const dn = document.getElementById('add-display-name').value.trim();
        const nn = document.getElementById('add-nickname').value.trim();
        const gg = document.getElementById('add-group').value;
        const err = document.getElementById('add-error');
        err.textContent = '';
        try {
          await insertPlayer({ display_name: dn, nickname: nn, group_name: gg });
          closeAddPlayerModal();
          await loadFaceitTable();
        } catch (ex) {
          err.textContent = ex.message;
        }
      }
    });

    document.addEventListener("DOMContentLoaded", loadFaceitTable);
  </script>

  <!-- Модальное окно -->
  <div id="faceit-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);"></div>
  <div id="faceit-modal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: var(--card-bg); border:1px solid var(--border-color); border-radius:16px; width:min(560px, calc(100% - 2rem)); box-shadow: var(--shadow-card); overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border-color);">
      <h3 id="faceit-modal-title" style="margin:0;">Подробная статистика</h3>
      <button id="faceit-modal-close" class="btn btn-secondary">Закрыть</button>
    </div>
    <div id="faceit-modal-body" style="padding:16px; color: var(--text-secondary);"></div>
  </div>

  <!-- Добавление игрока -->
  <div id="faceit-add-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);"></div>
  <div id="faceit-add-modal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: var(--card-bg); border:1px solid var(--border-color); border-radius:16px; width:min(560px, calc(100% - 2rem)); box-shadow: var(--shadow-card); overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border-color);">
      <h3 style="margin:0;">Добавить игрока</h3>
      <button id="faceit-add-close" class="btn btn-secondary">Закрыть</button>
    </div>
    <div style="padding:16px; display:grid; gap:12px;">
      <div>
        <label for="add-display-name" style="display:block; font-size:.85rem; color: var(--text-secondary); margin-bottom:.25rem;">Имя</label>
        <input id="add-display-name" type="text" placeholder="Например: makak1chh" style="width:100%; padding:.8rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary);">
      </div>
      <div>
        <label for="add-nickname" style="display:block; font-size:.85rem; color: var(--text-secondary); margin-bottom:.25rem;">Ник</label>
        <input id="add-nickname" type="text" placeholder="Ник на FACEIT" style="width:100%; padding:.8rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary);">
      </div>
      <div>
        <label for="add-group" style="display:block; font-size:.85rem; color: var(--text-secondary); margin-bottom:.25rem;">Группа</label>
        <select id="add-group" style="width:100%; padding:.8rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary);">
          <option>Без группы</option>
          <option>Черные</option>
          <option>Музыка</option>
        </select>
      </div>
      <p id="add-error" style="color:#f87171; margin:0;"></p>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button id="faceit-add-save" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>
</body>
</html>
